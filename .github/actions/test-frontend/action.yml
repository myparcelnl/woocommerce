name: 'Test frontend'
description: 'Run frontend tests'

runs:
  using: composite
  steps:
    - name: 'Run tests'
      shell: bash
      run: |
        yarn nx run-many \
          --output-style=static \
          --runner=cloud \
          --parallel=1 \
          --target=test:coverage

    - name: 'Move coverage files'
      shell: bash
      run: |
        mkdir -p coverage

        yarn workspaces foreach -pv --exclude '@myparcel/woocommerce' exec \
          bash -c 'if [ -f coverage/clover.xml ]; then mv coverage/clover.xml coverage/$(basename $(pwd)).xml; fi'

        find views -type f -name '*.xml' -exec mv {} coverage/ \;

    - uses: codecov/codecov-action@v3
      with:
        flags: frontend
        files: coverage/*.xml
