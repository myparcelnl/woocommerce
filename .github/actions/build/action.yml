name: 'Create build'
description: ''

inputs:
  app-id:
    description: 'GitHub App ID'
    required: true

  private-key:
    description: 'GitHub App Private Key'
    required: true

  php-scoper-version:
    description: 'PHP Scoper Version'
    required: true

outputs:
  token:
    description: 'GitHub Token'
    value: ${{ steps.credentials.outputs.token }}

  image:
    description: 'Docker image to use'
    value: ${{ steps.setup.outputs.image }}

runs:
  using: composite
  steps:
    - uses: ./.github/actions/setup
      id: setup
      with:
        composer-flags: --no-dev

    - name: 'Build frontend'
      shell: bash
      #language=sh
      run: |
        yarn nx run-many \
          --output-style=static \
          --runner=cloud \
          --target=build

    # The scoper is installed and run in pdk.config.js
    - name: 'Cache php-scoper'
      uses: actions/cache@v3
      id: php-scoper-cache
      with:
        path: .tmp/php-scoper
        key: php-scoper-${{ inputs.php-scoper-version }}

    - name: 'Cache scoped source php'
      uses: actions/cache@v3
      with:
        path: .tmp/scoped/source
        key: scoped-php-src-${{ hashFiles('src/**/*', 'config/**/*', 'woocommerce-myparcel.php', 'scoper.inc.php') }}

    - name: 'Cache scoped vendor php'
      uses: actions/cache@v3
      with:
        path: .tmp/scoped/vendor
        key: scoped-php-vendor-${{ hashFiles('**/composer.json', '**/composer.lock', 'scoper.inc.php', 'scoper.vendor.inc.php') }}
